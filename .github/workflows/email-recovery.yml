name: Email Recovery Helper

on:
  issues:
    types: [opened]

jobs:
  post-mailto-link:
    if: contains(github.event.issue.labels.*.name, 'email-recovery')
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Post mailto link
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const num = issue.number;
            const url = issue.html_url;

            const subject = encodeURIComponent('Email Recovery #' + num);
            const body = encodeURIComponent('Issue: ' + url + '\n\nPlease unsuppress the email address I am sending from.');
            const mailto = 'mailto:support@esoup.net?subject=' + subject + '&body=' + body;

            const lines = [
              '## ðŸ“§ One more step!',
              '',
              'Click this link to send your recovery request:',
              '',
              '### [Send Recovery Email](' + mailto + ')',
              '',
              'This opens your email client with everything pre-filled. Just hit **Send**.',
              '',
              '---',
              '',
              '_Your "from" address is what we\'ll unsuppress. We\'ll reply here once it\'s done._'
            ];

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: num,
              body: lines.join('\n')
            });
